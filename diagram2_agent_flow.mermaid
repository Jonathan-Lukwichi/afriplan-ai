flowchart TD
    START["ğŸ“„ Document Received"] --> INGEST["STAGE 1: INGEST\nPython extracts images + text\nPyMuPDF Â· Pillow"]
    INGEST --> CLASSIFY["STAGE 2: CLASSIFY\nClaude Haiku 4.5\nFast Â· Cheap Â· R0.18"]

    CLASSIFY --> RES{"Residential?"}
    CLASSIFY --> COM{"Commercial?"}
    CLASSIFY --> MAI{"Maintenance?"}

    RES -->|"Yes"| RES_P["Load\nDISCOVERY_RESIDENTIAL\nprompt"]
    COM -->|"Yes"| COM_P["Load\nDISCOVERY_COMMERCIAL\nprompt"]
    MAI -->|"Yes"| MAI_P["Load\nDISCOVERY_MAINTENANCE\nprompt"]

    RES_P --> SONNET["STAGE 3: DISCOVER\nClaude Sonnet 4.5\nExtract JSON with\nconfidence scores"]
    COM_P --> SONNET
    MAI_P --> SONNET

    SONNET --> CONF{"> 70% items\nHIGH or MEDIUM\nconfidence?"}
    CONF -->|"Yes âœ…"| VALIDATE["STAGE 4: VALIDATE"]
    CONF -->|"No âš ï¸"| OPUS["Escalate to\nClaude Opus 4.6\nRe-extract"]
    OPUS --> CONF2{"Acceptable\nnow?"}
    CONF2 -->|"Yes"| VALIDATE
    CONF2 -->|"Still poor"| MANUAL["Route to Manual Wizard\nPre-fill what was found"]

    VALIDATE --> HARD["Python Hard Rules\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ€¢ ELCB 30mA mandatory\nâ€¢ Max 10 lights/circuit\nâ€¢ Dedicated stove 32A\nâ€¢ Dedicated geyser 20A\nâ€¢ Voltage drop < 5%\nâ€¢ Min 15% spare DB ways"]
    VALIDATE --> SOFT["Claude Haiku Check\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ€¢ Point counts reasonable?\nâ€¢ Missing rooms?\nâ€¢ Cost risk items?\nâ€¢ Upsell opportunities?"]

    HARD --> MERGE["Merge all flags"]
    SOFT --> MERGE

    MERGE --> FLAGS{"Any CRITICAL\nflags?"}
    FLAGS -->|"None"| PRICE["STAGE 5: PRICE\nPython ONLY"]
    FLAGS -->|"Has critical"| FIX["Auto-fix critical\nAdd mandatory ELCB\nAdd missing dedicated circuits"]
    FIX --> PRICE

    PRICE --> MAT["Material cost\nconstants.py Ã— qty\nÃ— waste factor"]
    PRICE --> LAB["Labour cost\nrates Ã— points\nÃ— difficulty multiplier"]
    PRICE --> CABLE["Cable sizing\nSANS 10142-1 tables\n+ voltage drop check"]

    MAT --> TOTAL["Project Total\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nsubtotal\n+ contingency 7.5%\n+ overhead 10%\n+ profit margin\n+ VAT 15%\n= GRAND TOTAL"]
    LAB --> TOTAL
    CABLE --> TOTAL

    TOTAL --> OUTPUT["STAGE 6: OUTPUT"]
    OUTPUT --> PDF["ğŸ“„ PDF Quotation\nfpdf2"]
    OUTPUT --> EXCEL["ğŸ“Š Excel BOQ\nopenpyxl"]
    OUTPUT --> DISPLAY["ğŸ–¥ï¸ Streamlit Display\nEditable before export"]

    style START fill:#1a237e,color:#fff
    style SONNET fill:#ff6f00,color:#fff
    style OPUS fill:#d32f2f,color:#fff
    style PRICE fill:#2e7d32,color:#fff
    style TOTAL fill:#2e7d32,color:#fff
    style MANUAL fill:#f57f17,color:#000
